# z80asm - Z80 module assembler, linker, librarian

**z80asm** is part of the [z88dk](http://www.z88dk.org/) project and is used as the back-end of the z88dk C compilers. It is not to be confused with other non-**z88dk** related projects with the same name.

**z80asm** is a relocatable assembler, linker and librarian that can assemble Intel 8080/8085 and Z80-family assembly files into a relocatable object format, can manage sets of object files in libraries and can build binary images by linking these object files together. The binary images can be defined in different sections, to match the target architecture.

**NOTE**: This document is a work-in-porgress. It describes the functionality already working in the assembler in the **z80asm2** branch. This document and the ```z80asm-future-md``` will converge as **z80asm2** gets more features and converges to the current capability of **z80asm** in the **master** branch.

## Usage ...

## Options 

### Preprocessor options

#### -atoctal (at is octal prefix)

By default the at-character (```@```) is used as a binary number prefix. 

With the option ```-atoctal``` it is used as the octal number prefix instead.

#### -dotdirective (period is directive prefix)

By default the period (```.```) is used to signal that the next identifier is a label. 

With the option ```-dotdirective``` it is used instead to signal that the next identifier is an assembler directive.

#### -hashhex (hash is hex prefix)

By default the hash-character (```#```) is used to signal that the next expression should be compiled as an immediate value. This meaning, although common in assemblers, is a no-operation in **z80asm**. 

With the option ```-hashhex``` the hash-character is used as the hexadecimal number prefix instead.

#### -labelcol1 (labels at column 1)

By default **z80asm** needs either a period (```.```) prefix (but see ```-dotdirective```) or a colon (```:```) suffix to signal that an identifier is a label, and white space at the beginning of a line is not significant.

With the option ```-labelcol1``` an identifier is a label if started at column 1, or a directive or opcode if started after white space.

#### -ucase (upper case)

By default **z80asm** is case-sensitive for identifiers, but case-insensitive for assembly keywords (opcodes, directives, registers and flags).

The option ```-ucase``` causes **z80asm** to convert all the symbols to upper-case, so that code that assumes case-insentivity can be assembled.





## Input Files

### Source File Format

The assembler parses source files with any of the common end-of-line termination sequences (```"\r"```, ```"\n"``` or ```"\r\n"```). Each line starts with an optional label and can contain assembly directives (i.e. instructions to the assembler), assembly instructions (i.e. code to be translated into object code for the specific processor) or blanks and comments.

A single backslash character (```\```) may be used to separate multiple statements in a single line.

    org 0                     ; assembly directive  
    start: push bc\pop hl     ; define a label and add two assembly opcodes              
    ret                       ; assembly opcode can be at the first column    

Differently to most other assemblers, white space is not significant, i.e. a label can be defined after white space, and an opcode can be written at column 1 (but see option ```-labelcol1```).

### Comments

Comments may start with a semi-colon (```;```) or two slashes (```//```) and end at the end of the line, or may start with slash-star (```/*```) and end with star-slash (```*/```), possibly spanning multiple lines.

    ld a, 1                   ; this is a comment
    ld b, 2                   // another comment
    ld c, /* multi-line comment is valid
             in the middle of an instruction 
          */ 3                ; C = 3

### Symbols

All symbols in the code (labels, variables, ...) are named with unique identifiers. Identifiers start with a letter or underscore (```_```), and can contain letters, digits, underscores or periods (```.```). Identifiers are case-sensitive (but see option ```-ucase```).

### Labels

A label is a symbol that represents the current assembly address (```ASMPC```) and is defined at the start of a line by prefixing a symbol with a period (```.```) (but see ```-dotdirective```) or suffixing it with a colon (```:```), i.e. either ```.label``` or ```label:``` (but see ```-labelcol1```).

### Numbers

The assembler accepts numbers in decimal, hexadecimal, octal and binary. Different syntaxes are allowed to simplify porting code written for other assemblers. Some of the prefix characters are also used as operators; in this case a space may be needed to signal the difference, e.g.

    ld a, %10     ; A = 2 (10 binary)
    ld a, 12 % 10 ; A = 2 (remainder of 12 divided by 10)

All expressions are computed as signed integers with the host platform's integer size (32-bit or 64-bit in the most common platforms). Expression evaluation follows the operator precedence of C (but see ```-noprec```).

#### Decimal

Decimal numbers are a sequence of decimal digits (```0..9```), optionally followed by a ```d``` or ```D``` - all prefixes and suffixes are case-insensitive. Leading zeros are insignificant - note the difference from C, where a leading zero means octal.

    ld a, 99
    ld a, 99d

#### Hexadecimal

Hexadecimal numbers are a sequence of hexadecimal digits (```0..9``` and ```A..F```, case-insensitive), either prefixed or suffixed with an hexadecimal marker. If the marker is a suffix, and the number starts with a letter, then a leading zero has to be added.

The hexadecimal prefix ```$``` is also the ```ASMPC``` identifier if not followed by a hexadecimal number, i.e. the address of the instruction being assembled.

The hexadecimal prefix ```#``` is only recognized with the option ```-hashhex```.

    ld a, $FF
    ld a, #FF          ; only with option -hashhex
    ld a, 0xFF
    ld a, 0FFh

#### Octal

Octal numbers are a sequence of octal digits (```0..7```), either prefixed or suffixed with an octal marker. 

The octal-prefix ```@``` is only recognized with the option ```-atoctal```.

    ld a, @77          ; only with option -atoctal
    ld a, 0o77
    ld a, 0q77
    ld a, 77o
    ld a, 77q

#### Binary

Binary numbers are a sequence of binary digits (```0..1```), either prefixed or suffixed with a binary marker.  

The binary prefix ```%``` is also the modulus operator, if not followed by a binary digit. 

The binary prefix ```@``` is recognized unless the option ```-atoctal``` is given.

    ld a, %11
    ld a, @11           ; except with option -atoctal
    ld a, 0b11
    ld a, 11b

#### Bitmaps

Binary numbers can be specified as bitmaps, with ```#``` as ```1``` and ```-``` as ```0```, using the binary prefix (```@``` or ```%```) immediately followed by a double-quoted string of hashes and dashes.

    defb @"---##---"
    defb @"-##--##-"
    defb %"-##-----"
    defb %"-##-----"
    defb @"-##--##-"
    defb @"---##---"


### Keywords

Processor registers (```BC```, ```DE```, ...) and flags (```NZ```, ```Z```, ...), and assembly ```ASMPC```, representing the current assembly location, are reserved keywords. They cannot be used as identifiers, and are case-insensitive.

### Directives and Opcodes

Assembler directives (```ORG```, ```INCLUDE```, ...) and processor opcodes (```NOP```, ```LD```, ...) are interpreted as directives or opcodes when appearing at the start of the statement or after a label definition, or as regular identifiers otherwise. The directives and opcodes are case-insensitive.

    jr: jr jr  ; silly example, jr is both a label and an opcode
               ; while correct code, it's confusing, don't do it

## Object File Format

### Object Files

### Library File Format

## Copyright

The original z80asm module assembler was written by Gunther Strube. 
It was converted from QL SuperBASIC version 0.956, initially ported to Lattice C,
and then to C68 on QDOS.

It has been maintained since 2011 by Paulo Custodio.

Copyright (C) Gunther Strube, InterLogic 1993-99  
Copyright (C) Paulo Custodio, 2011-2020

## License

Artistic License 2.0 [http://www.perlfoundation.org/artisticlicense2_0](http://www.perlfoundation.org/artisticlicense2_0 "Artistic License 2.0")
